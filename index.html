<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Forestry TIFF Test</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- GeoTIFF stack（動作実績のある並び） -->
  <script src="https://unpkg.com/geotiff"></script>
  <script src="https://unpkg.com/proj4"></script>
  <script src="https://unpkg.com/georaster"></script>
  <script src="https://unpkg.com/georaster-layer-for-leaflet"></script>

  <!-- d3（将来拡張用。凡例はプレーンJSで生成） -->
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <style>
    html, body, #map { height:100%; margin:0; }
    .leaflet-control.custom {
      background:#fff; padding:8px; border-radius:6px;
      box-shadow:0 2px 6px rgba(0,0,0,.2); font:14px/1.2 system-ui, sans-serif;
      display:flex; gap:8px; align-items:center;
    }
    .legend { background:#fff; padding:6px; border-radius:6px; font:12px/1.2 system-ui, sans-serif; }
    .legend div { display:flex; align-items:center; }
    .legend span { width:20px; height:12px; margin-right:6px; display:inline-block; }
    select, button, input[type="range"] { font:inherit; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    // ====== 基本セットアップ（既存の成功形を維持） ======
    const map = L.map('map').setView([41.97, 140.67], 11);

    // ▼ベースマップ定義：OSM（既定）＋ 航空写真（Esri/GSI）
    const baseOSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap'
    }).addTo(map); // 初期はOSM

    const baseEsri = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      { attribution: 'Tiles © Esri — Source: Esri, Maxar, Earthstar Geographics, and the GIS User Community' }
    );

    const baseGSI = L.tileLayer(
      'https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg',
      { attribution: '© 国土地理院' }
    );

    // レイヤコントロール（ベース切替）
    const baseLayers = {
      '地図（OSM）': baseOSM,
      '航空写真（Esri）': baseEsri,
      '航空写真（GSI）': baseGSI
    };
    const overlays = {};
    const layerControl = L.control.layers(baseLayers, overlays, { collapsed: false }).addTo(map);

    // ====== レイヤ一覧（TIFF切替用） ======
    const LAYERS = {
      "樹高 2024-08": "data/onuma_canopy_height_8bit.tif",
      "樹高 2024-07（テスト）": "data/onuma_canopy_height_8bit.tif" // 別tifが用意できたら差し替え
    };

    // ====== 表示スタイル（カテゴリ凡例：0–10/10–20/20–30/30–40m） ======
    const breaks = [0, 10, 20, 30, 40];
    const colors = ["#ffffcc", "#a1dab4", "#41b6c4", "#225ea8"];

    let rasterLayer = null;         // 現在のGeoRasterLayer
    let overlayRef = null;          // Layersコントロール用の参照
    const ui = { select:null, slider:null, toggle:null };

    // ====== TIFF読込（既存の流れを踏襲） ======
    async function loadRaster(url) {
      try {
        setUIEnabled(false);

        // キャッシュバスターで確実に再読込
        const bust = (url.includes('?') ? '&' : '?') + 'v=' + Date.now();
        console.log('[loadRaster]', url + bust);
        const res = await fetch(url + bust, { cache: 'no-store' });
        const buf = await res.arrayBuffer();
        const georaster = await parseGeoraster(buf);

        if (rasterLayer && map.hasLayer(rasterLayer)) map.removeLayer(rasterLayer);

        const prevOpacity = (rasterLayer && rasterLayer.options.opacity) || 0.7;

        rasterLayer = new GeoRasterLayer({
          georaster,
          opacity: prevOpacity,
          pixelValuesToColorFn: values => {
            const v = values[0];
            if (v === 0 || v === null) return null;   // 0/nullは透過
            const m = (v / 255) * 40;                 // 8bit → 樹高[0–40m]
            for (let i=0; i<breaks.length-1; i++) {
              if (m >= breaks[i] && m < breaks[i+1]) return colors[i];
            }
            return colors[colors.length-1];
          }
        });

        rasterLayer.addTo(map);
        map.fitBounds(rasterLayer.getBounds(), { padding:[10,10] });

        // レイヤコントロールへ登録（重複登録を避ける）
        if (overlayRef) layerControl.removeLayer(overlayRef);
        layerControl.addOverlay(rasterLayer, '樹高');
        overlayRef = rasterLayer;

      } catch (e) {
        console.error("読み込みエラー:", e);
        alert("TIFFの読み込みに失敗しました: " + (e.message || e));
      } finally {
        syncUI();
        setUIEnabled(true);
      }
    }

    // ====== 凡例（カテゴリ凡例） ======
    function addLegend() {
      const legend = L.control({position: "bottomright"});
      legend.onAdd = function () {
        const div = L.DomUtil.create("div", "legend");
        for (let i=0; i<breaks.length-1; i++) {
          div.innerHTML += `<div><span style="background:${colors[i]}"></span>${breaks[i]}–${breaks[i+1]}m</div>`;
        }
        return div;
      };
      legend.addTo(map);
    }

    // ====== UI（レイヤ選択＋透過度＋表示切替） ======
    function addControls() {
      const control = L.control({position: "topright"});
      control.onAdd = function() {
        const div = L.DomUtil.create("div", "leaflet-control custom");
        L.DomEvent.disableClickPropagation(div);

        // レイヤ選択
        ui.select = document.createElement("select");
        for (const label in LAYERS) {
          const opt = document.createElement("option");
          opt.value = LAYERS[label];
          opt.textContent = label;
          ui.select.appendChild(opt);
        }
        const handleSelect = e => {
          const nextUrl = e.target.value;
          console.log('[select]', nextUrl);
          loadRaster(nextUrl);
        };
        ui.select.addEventListener('input', handleSelect);
        ui.select.addEventListener('change', handleSelect);
        div.appendChild(ui.select);

        // 透過度
        ui.slider = document.createElement("input");
        ui.slider.type = "range"; ui.slider.min = 0; ui.slider.max = 1; ui.slider.step = 0.1; ui.slider.value = 0.7;
        ui.slider.oninput = e => { if (rasterLayer) rasterLayer.setOpacity(parseFloat(e.target.value)); };
        div.appendChild(ui.slider);

        // 表示/非表示
        ui.toggle = document.createElement("button");
        ui.toggle.textContent = "非表示";
        ui.toggle.onclick = () => {
          if (!rasterLayer) return;
          if (map.hasLayer(rasterLayer)) map.removeLayer(rasterLayer);
          else rasterLayer.addTo(map);
          syncUI();
        };
        div.appendChild(ui.toggle);

        return div;
      };
      control.addTo(map);
    }

    // ====== UI同期＆活性/非活性 ======
    function syncUI() {
      if (ui.slider) ui.slider.value = rasterLayer ? rasterLayer.options.opacity : 0.7;
      if (ui.toggle) {
        const visible = rasterLayer && map.hasLayer(rasterLayer);
        ui.toggle.textContent = visible ? "非表示" : "表示";
      }
    }
    function setUIEnabled(enabled) {
      if (ui.select) ui.select.disabled = !enabled;
      if (ui.slider) ui.slider.disabled = !enabled;
      if (ui.toggle) ui.toggle.disabled = !enabled;
    }

    // ====== 起動（UI/凡例追加 → 既定レイヤ読込） ======
    addLegend();
    addControls();
    if (ui.select) ui.select.value = LAYERS["樹高 2024-08"];  // 既定をUIに反映
    setUIEnabled(false);
    loadRaster(LAYERS["樹高 2024-08"]);
  </script>
</body>
</html>
