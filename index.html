<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KAKEHASHI | 森林の樹高ダッシュボード</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- GeoTIFF / GeoRaster stack -->
<script src="https://unpkg.com/proj4@2.9.2/dist/proj4.js"></script>
<script src="https://unpkg.com/geotiff@2.0.7/dist-browser/geotiff.min.js"></script>
<script src="https://unpkg.com/georaster@1.6.1/dist/georaster.browser.js"></script>
<script src="https://unpkg.com/georaster-layer-for-leaflet@3.11.0/dist/georaster-layer-for-leaflet.min.js"></script>

<!-- Inter font（任意） -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0b1020; --panel:#111827; --text:#e5e7eb; --muted:#9ca3af;
  --accent:#22d3ee; --line:#243045; --chip:#0b1326; --chipb:#2a3953;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,ui-sans-serif;background:var(--bg);color:var(--text)}
.app{display:grid; grid-template-columns: 340px 1fr; gap:12px; height:100%; padding:12px}
@media (max-width: 980px){ .app{ grid-template-columns: 1fr; grid-template-rows: auto 1fr } }

.panel{
  background:linear-gradient(180deg,#0f172a,#0b1326 60%); border:1px solid var(--line);
  border-radius:16px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.2)
}
h1{font-size:18px;margin:0 0 8px; font-weight:800}
.sub{color:var(--muted); font-size:12px; margin-bottom:12px}
.row{display:flex; gap:8px; align-items:center; margin:8px 0}
.input{flex:1; background:#0e1629; color:var(--text); border:1px solid #1f2b44; border-radius:10px; padding:10px 12px; outline:none}
.btn{background:var(--accent); color:#001018; font-weight:700; border:none; border-radius:10px; padding:10px 12px; cursor:pointer}
.btn:disabled{opacity:.5; cursor:not-allowed}
.kv{display:flex; justify-content:space-between; color:var(--muted); font-size:12px; margin-top:6px}
.legend{margin-top:10px; background:#0e1629; padding:10px; border:1px solid #1f2b44; border-radius:12px}
.legend-bar{height:12px; width:100%; border-radius:8px; margin:6px 0; background:linear-gradient(90deg,#f7fcf5,#e5f5e0,#c7e9c0,#a1d99b,#74c476,#41ab5d,#238b45,#006d2c,#00441b)}
.small{font-size:12px; color:var(--muted)}
hr{border:none; border-top:1px solid var(--line); margin:10px 0}

.map{position:relative; border:1px solid var(--line); border-radius:16px; overflow:hidden}
#map{height:100%; min-height:520px}

.toast{
  position:fixed; right:16px; bottom:16px; background:#0e1629; color:var(--text);
  border:1px solid #1f2b44; padding:10px 12px; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.25);
  opacity:0; transform:translateY(10px); transition:.3s; pointer-events:none;
}
.toast.show{opacity:1; transform:none}
a.link{color:var(--accent); text-decoration:none}
</style>
</head>

<body>
<div class="app">
  <!-- ======= 左パネル ======= -->
  <aside class="panel">
    <h1>森林の樹高ダッシュボード</h1>
    <div class="sub">GEE出力の GeoTIFF（8bit）を読み込み、0–40 mで可視化します。</div>

    <div class="row">
      <input id="url" class="input" placeholder="GeoTIFF の URL を入力"
             value="data/onuma_canopy_height_8bit.tif">
      <button id="btnLoad" class="btn">読込</button>
    </div>

    <div class="row">
      <button id="btnFocus" class="btn" style="flex:1">大沼にフォーカス</button>
      <div class="small" style="flex:1; text-align:right">
        透過度 <input id="opacity" type="range" min="0" max="1" step="0.01" value="0.85">
      </div>
    </div>

    <div class="legend">
      <div style="display:flex; justify-content:space-between; align-items:center">
        <div style="font-weight:700">Canopy Height (m)</div>
        <div class="small"><span id="resInfo">—</span></div>
      </div>
      <div class="legend-bar" id="legendBar"></div>
      <div class="kv"><span>0</span><span>10</span><span>20</span><span>30</span><span>40</span></div>
      <div class="small">値域は固定 0–40 m（8bitは自動で 0–255 → 0–40 m に戻します）</div>
    </div>

    <hr>
    <div class="small">
      <b>Tips:</b> 右上の <em>Apps Script</em> が Drive の最新TIFFを
      <code>data/onuma_canopy_height_8bit.tif</code> に自動コミットします。
      更新が反映されない場合はこのページを再読み込み、または URL の末尾に
      <code>?v=timestamp</code> を付けてください。
    </div>
  </aside>

  <!-- ======= 地図 ======= -->
  <main class="map"><div id="map"></div></main>
</div>

<div id="toast" class="toast"></div>

<script>
/* ====== グローバル ====== */
let map, rasterLayer=null;
const DEFAULT_URL = 'data/onuma_canopy_height_8bit.tif';
const PALETTE_HEIGHT = ['#f7fcf5','#e5f5e0','#c7e9c0','#a1d99b','#74c476','#41ab5d','#238b45','#006d2c','#00441b'];
const HEIGHT_MIN = 0, HEIGHT_MAX = 40;

/* ====== UIヘルパ ====== */
const $ = sel => document.querySelector(sel);
function toast(msg){
  const t = $('#toast'); t.textContent = msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), 2200);
}

/* ====== マップ初期化 ====== */
(function init(){
  map = L.map('map', {zoomControl:true}).setView([41.97, 140.74], 11); // 大沼近辺
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  $('#btnLoad').addEventListener('click', ()=> loadTiff($('#url').value.trim()));
  $('#btnFocus').addEventListener('click', ()=> map.setView([41.97, 140.74], 12));
  $('#opacity').addEventListener('input', e=>{
    if(rasterLayer) rasterLayer.setOpacity(parseFloat(e.target.value));
  });

  // 初回自動読込（キャッシュ回避のためバスター付与）
  const startUrl = ($('#url').value || DEFAULT_URL) + '?v=' + Date.now();
  loadTiff(startUrl);
})();

/* ====== 256色LUTを生成（線形補間） ====== */
function buildLUT(palette){
  const cols=[], n=palette.length;
  const h2r=h=>[parseInt(h.slice(1,3),16),parseInt(h.slice(3,5),16),parseInt(h.slice(5,7),16)];
  const r2h=(r,g,b)=>'#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('');
  for(let i=0;i<256;i++){
    const t=i/255, p=t*(n-1), i0=Math.floor(p), i1=Math.min(n-1,i0+1), lt=p-i0;
    const [r0,g0,b0]=h2r(palette[i0]); const [r1,g1,b1]=h2r(palette[i1]);
    const r=Math.round(r0+(r1-r0)*lt), g=Math.round(g0+(g1-g0)*lt), b=Math.round(b0+(b1-b0)*lt);
    cols.push(r2h(r,g,b));
  }
  return cols;
}
const LUT = buildLUT(PALETTE_HEIGHT);

/* ====== GeoTIFF 読込とレイヤ作成 ====== */
async function loadTiff(url){
  try{
    $('#btnLoad').disabled = true;
    toast('読み込み中…');

    // 取得
    const res = await fetch(url, {cache:'no-store'});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const buf = await res.arrayBuffer();

    const georaster = await parseGeoraster(buf);
    const image = (await GeoTIFF.fromArrayBuffer(buf)).getImage(0);

    // 0–40m に正規化（8bitは 0–255 → 0–40m に戻す）
    const isUint8 = (georaster.dataType||'').toLowerCase().includes('8');
    const toIdx = v=>{
      if(v==null || Number.isNaN(v)) return null;
      if(isUint8) v = (v/255)*(HEIGHT_MAX - HEIGHT_MIN) + HEIGHT_MIN;
      const t = Math.max(0, Math.min(1, (v - HEIGHT_MIN)/(HEIGHT_MAX - HEIGHT_MIN)));
      return Math.round(t*255);
    };

    // 旧レイヤは除去
    if(rasterLayer) { map.removeLayer(rasterLayer); rasterLayer=null; }

    rasterLayer = new GeoRasterLayer({
      georaster, resolution: 256, opacity: parseFloat($('#opacity').value),
      pixelValuesToColorFn: values => {
        const v = values[0];
        const idx = toIdx(v);
        return (idx==null) ? null : LUT[idx];
      }
    }).addTo(map);

    // TIFF の外接矩形に合わせてフィット
    const bb = rasterLayer.getBounds();
    if(bb && bb.isValid()) map.fitBounds(bb, {padding:[20,20]});

    // 解像度情報
    const scale = georaster.pixelWidth || georaster.pixelHeight || null;
    $('#resInfo').textContent = scale ? `${(scale).toFixed(1)} m/pix` : '—';

    toast('読み込み完了');
  }catch(err){
    console.error(err);
    toast('読み込みに失敗しました（詳細はConsole）');
  }finally{
    $('#btnLoad').disabled = false;
  }
}
</script>
</body>
</html>
