<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KAKEHASHI | Forestry MVP (NDVI with Opacity & Legend)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- ===== GeoTIFF / GeoRaster stack（順番が重要） ===== -->
  <script src="https://unpkg.com/geotiff@2.1.3/dist-browser/geotiff.min.js"></script>
  <script src="https://unpkg.com/proj4@2.9.2/dist/proj4.js"></script>
  <script src="https://unpkg.com/georaster@1.6.1/dist/georaster.browser.min.js"></script>
  <script src="https://unpkg.com/georaster-proj4@1.7.2/dist/georaster-proj4.browser.min.js"></script>
  <script src="https://unpkg.com/georaster-layer-for-leaflet@3.15.0/dist/georaster-layer-for-leaflet.min.js"></script>

  <style>
    /* CSSはそのまま。省略可 */
  </style>
</head>
<body>
  <!-- 元の HTML 構造をそのまま使用（中略） -->

<script>
  // ====== 基本設定 ======
  const DEFAULT_PATH = 'data/onuma_ndvi_2024_summer.tif';
  const PALETTE_NDVI = ['#f7f7f7','#d9ef8b','#a6d96a','#66bd63','#1a9850','#006837'];
  const NDVI_DOMAIN_DEFAULT = [-0.2, 0.9];

  // ====== ユーティリティ ======
  function logMsg(msg,isErr=false){
    const el=document.getElementById('log'); const p=document.createElement('div');
    p.className='logline'+(isErr?' err':''); p.textContent=(isErr?'ERROR: ':'')+msg;
    el.appendChild(p); console[isErr?'error':'log'](msg);
  }
  function makeGradientCSS(colors){ return `linear-gradient(to right, ${colors.join(',')})`; }
  function updateLegend(vmin,vmax,colors,title='NDVI'){
    const box=document.getElementById('legend'); const grad=document.getElementById('grad');
    document.getElementById('legendTitle').textContent = title;
    document.getElementById('minLbl').textContent = vmin.toFixed(2);
    document.getElementById('midLbl').textContent = ((vmin+vmax)/2).toFixed(2);
    document.getElementById('maxLbl').textContent = vmax.toFixed(2);
    grad.style.background = makeGradientCSS(colors); box.style.display = 'block';
  }
  function hideLegend(){ document.getElementById('legend').style.display='none'; }

  // ====== Leaflet 初期化 ======
  const map=L.map('map',{zoomControl:true,attributionControl:true}).setView([41.98,140.70],11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'© OpenStreetMap'}).addTo(map);
  document.getElementById('fitOnuma').onclick=()=>map.setView([41.98,140.70],11);

  let activeLayer=null;

  // ====== 読み込み処理 ======
  async function fetchArrayBufferSmart(urlOrFile){
    if(urlOrFile instanceof File){return await urlOrFile.arrayBuffer();}
    const u = new URL(urlOrFile, window.location.href);
    const same = (u.origin===window.location.origin);
    const res = await fetch(u.href, {mode: same?'same-origin':'cors', cache:'no-store'});
    if(!res.ok) throw new Error(`HTTP ${res.status} for ${u.href}`);
    return await res.arrayBuffer();
  }

  function getParseGeoraster(){
    return (window.parseGeoraster) ||
           (window.georaster && window.georaster.parseGeoraster) ||
           (window.GeoRaster && window.GeoRaster.parseGeoraster);
  }

  async function loadGeoTiff(source){
    try{
      const parse = getParseGeoraster();
      if(typeof parse!=='function') throw new ReferenceError('parseGeoraster is not available');

      if(typeof GeoRasterLayer === 'undefined') throw new ReferenceError('GeoRasterLayer is not defined');

      const buf = await fetchArrayBufferSmart(source);
      const georaster = await parse(buf);
      logMsg(`loaded: ${georaster.width}x${georaster.height}, bands=${georaster.numberOfRasters}, type=${georaster.dataType}`);

      const isRGB = georaster.numberOfRasters>=3 && String(georaster.dataType).includes('8');
      let options = { opacity: parseFloat(document.getElementById('opacity').value), resolution:256, resampleMethod:'bilinear' };

      if(isRGB){
        hideLegend();
      }else{
        const band=0, mins=georaster.mins||[], maxs=georaster.maxs||[];
        let vmin = (Number.isFinite(mins[band])?mins[band]:NDVI_DOMAIN_DEFAULT[0]);
        let vmax = (Number.isFinite(maxs[band])?maxs[band]:NDVI_DOMAIN_DEFAULT[1]);
        if(vmax - vmin <= 1e-6){ vmin=NDVI_DOMAIN_DEFAULT[0]; vmax=NDVI_DOMAIN_DEFAULT[1]; }

        const lut = (steps=256)=>{
          const cols=[]; const n=PALETTE_NDVI.length;
          const hex2rgb=h=>[parseInt(h.slice(1,3),16),parseInt(h.slice(3,5),16),parseInt(h.slice(5,7),16)];
          const rgb2hex=(r,g,b)=>'#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('');
          for(let i=0;i<steps;i++){
            const t=i/(steps-1), p=t*(n-1), i0=Math.floor(p), i1=Math.min(n-1,i0+1), lt=p-i0;
            const [r0,g0,b0]=hex2rgb(PALETTE_NDVI[i0]); const [r1,g1,b1]=hex2rgb(PALETTE_NDVI[i1]);
            const r=Math.round(r0+(r1-r0)*lt), g=Math.round(g0+(g1-g0)*lt), b=Math.round(b0+(b1-b0)*lt);
            cols.push(rgb2hex(r,g,b));
          }
          return cols;
        };
        const colors = lut();
        const toIdx = v => {
          const t = Math.max(0, Math.min(1, (v - vmin)/(vmax - vmin)));
          return Math.min(255, Math.max(0, Math.round(t*255)));
        };
        options.pixelValuesToColorFn = (vals)=>{ const v=vals[band]; if(v==null||Number.isNaN(v)) return null; return colors[toIdx(v)]; };
        updateLegend(vmin, vmax, PALETTE_NDVI, 'NDVI');
      }

      const layer = new GeoRasterLayer({ georaster, ...options });
      if(activeLayer) map.removeLayer(activeLayer);
      activeLayer = layer.addTo(map);
      try{ map.fitBounds(layer.getBounds(),{padding:[10,10]}); }catch(e){}

    }catch(err){
      logMsg(err.message||String(err), true);
      alert('読み込みに失敗しました。パス/サイズ/CRS をご確認ください。');
    }
  }

  // ====== UI 結線 ======
  document.getElementById('load').onclick = ()=>{ const path=document.getElementById('url').value.trim(); if(path) loadGeoTiff(path); };
  document.getElementById('quick').onclick = ()=>{ document.getElementById('url').value = DEFAULT_PATH; loadGeoTiff(DEFAULT_PATH); };
  document.getElementById('pick').onclick = ()=> document.getElementById('file').click();
  document.getElementById('file').onchange = (e)=> { const f=e.target.files?.[0]; if(f) loadGeoTiff(f); };
  document.getElementById('opacity').oninput = (e)=>{ const v=parseFloat(e.target.value); document.getElementById('opv').textContent=v.toFixed(2); if(activeLayer) activeLayer.setOpacity(v); };

  // 起動時：既定パスが 200 OK なら自動読込
  window.addEventListener('load', async ()=>{
    try{
      const u=new URL(DEFAULT_PATH, window.location.href);
      const res=await fetch(u.href,{method:'HEAD',mode:'same-origin',cache:'no-store'});
      if(res.ok){ document.getElementById('url').value=DEFAULT_PATH; loadGeoTiff(DEFAULT_PATH); }
    }catch(e){}
  });
</script>
</body>
</html>
