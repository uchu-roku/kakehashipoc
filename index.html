<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Forestry TIFF Test</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- GeoTIFF stack -->
  <script src="https://unpkg.com/geotiff"></script>
  <script src="https://unpkg.com/proj4"></script>
  <script src="https://unpkg.com/georaster"></script>
  <script src="https://unpkg.com/georaster-layer-for-leaflet"></script>

  <!-- ✅ d3本体（含むscale, interpolate, すべて） -->
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <style>
    html, body, #map { height:100%; margin:0; }
    .legend {
      background: white;
      padding: 6px;
      font-size: 12px;
      line-height: 1.2em;
    }
    .legend div { display:flex; align-items:center; }
    .legend span {
      width:20px; height:12px; margin-right:6px; display:inline-block;
    }
    .leaflet-control.custom {
      background: white;
      padding: 8px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    const map = L.map('map').setView([41.97, 140.67], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: "© OpenStreetMap"
    }).addTo(map);

    const url = "data/onuma_canopy_height_8bit.tif";

    // グラデーションスケール（0～40mを想定）
    const colorScale = d3.scaleSequential()
      .domain([0, 40])
      .interpolator(d3.interpolateYlGnBu);  // ✅ interpolate関数を利用

    let rasterLayer;

    fetch(url)
      .then(res => res.arrayBuffer())
      .then(arrayBuffer => parseGeoraster(arrayBuffer))
      .then(georaster => {
        rasterLayer = new GeoRasterLayer({
          georaster,
          opacity: 0.7,
          pixelValuesToColorFn: values => {
            const v = values[0];
            if (v === 0 || v === null) return null;
            const m = (v / 255) * 40; // 0–40m に正規化
            return colorScale(m);    // ✅ ここがエラー原因 → 修正済み
          }
        });
        rasterLayer.addTo(map);
        map.fitBounds(rasterLayer.getBounds());

        addLegend();
        addControls();
      })
      .catch(err => console.error("読み込みエラー:", err));

    // 凡例追加
    function addLegend() {
      const legend = L.control({position: "bottomright"});
      legend.onAdd = function () {
        const div = L.DomUtil.create("div", "legend");
        const grades = [0, 10, 20, 30, 40];
        grades.forEach((g, i) => {
          const next = grades[i+1];
          if (next !== undefined) {
            const c = colorScale((g+next)/2);
            div.innerHTML += `<div><span style="background:${c}"></span>${g}–${next}m</div>`;
          }
        });
        return div;
      };
      legend.addTo(map);
    }

    // UI操作（透過度スライダー、表示切替）
    function addControls() {
      const control = L.control({position: "topright"});
      control.onAdd = function() {
        const div = L.DomUtil.create("div", "leaflet-control custom");

        // スライダー
        const slider = document.createElement("input");
        slider.type = "range"; slider.min = 0; slider.max = 1; slider.step = 0.1; slider.value = 0.7;
        slider.oninput = e => { rasterLayer.setOpacity(e.target.value); };
        div.appendChild(slider);

        // 表示切替
        const btn = document.createElement("button");
        btn.innerText = "表示/非表示";
        btn.style.marginLeft = "6px";
        btn.onclick = () => {
          if (map.hasLayer(rasterLayer)) {
            map.removeLayer(rasterLayer);
          } else {
            rasterLayer.addTo(map);
          }
        };
        div.appendChild(btn);

        return div;
      };
      control.addTo(map);
    }
  </script>
</body>
</html>
