<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KAKEHASHI | Forestry MVP (NDVI with Opacity & Legend)</title>

<!-- GitHub Pages ルート（相対パス安定化） -->
<base href="https://uchu-roku.github.io/kakehashipoc/">

<!-- Leaflet（安定） -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Font: Inter（指定しているので明示読込） -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root{--bg:#0b1020;--panel:#111827;--text:#e5e7eb;--muted:#9ca3af;--line:#243045}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,ui-sans-serif}
.app{display:grid;grid-template-columns:360px 1fr;grid-template-rows:auto 1fr;grid-template-areas:"head head" "side map";height:100%}
.head{grid-area:head;padding:10px 14px;border-bottom:1px solid var(--line);display:flex;gap:12px;align-items:center}
.side{grid-area:side;border-right:1px solid var(--line);padding:12px;overflow:auto;background:#0f162c}
.map{grid-area:map}#map{height:100%;width:100%}
.card{background:#0f1934;border:1px solid #1f2a44;border-radius:14px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);margin-bottom:12px}
.card h3{margin:0 0 8px;font-size:13px}
.row{display:flex;gap:8px;align-items:center;margin-top:8px}
.input{flex:1;background:#0b1326;border:1px solid #223153;color:var(--text);padding:8px 10px;border-radius:10px}
.btn{background:#1c2750;border:1px solid #293a64;color:#e6f6ff;padding:8px 10px;border-radius:10px;cursor:pointer}
.small{font-size:12px;color:#9ca3af}
.slider{width:100%}
.badge{font-size:11px;background:#132042;color:#c8eefd;border:1px solid #274071;padding:2px 6px;border-radius:999px}
.legend{position:absolute;right:12px;bottom:12px;background:rgba(15,25,52,.9);border:1px solid #1f2a44;border-radius:10px;padding:10px;min-width:180px}
.legend h4{margin:0 0 8px;font-size:12px;color:#cfe7ff}
.gradient{height:14px;border-radius:4px;border:1px solid rgba(255,255,255,.2);margin:6px 0}
.legend-scale{display:flex;justify-content:space-between;font-size:11px;color:#cbd5e1}
hr{border:none;border-top:1px solid #1f2a44;margin:10px 0}
.logline{white-space:pre-wrap}.err{color:#ffb4b4}
</style>
</head>
<body>
<div class="app">
  <div class="head">
    <strong>KAKEHASHI Forestry MVP</strong>
    <span class="badge">Stage 0</span>
    <span class="small">NDVI 表示（透過スライダー＋凡例）</span>
  </div>

  <aside class="side">
    <div class="card">
      <h3>ベースマップ</h3>
      <div class="row">
        <button class="btn" id="fitOnuma">大沼にフォーカス</button>
      </div>
    </div>

    <div class="card">
      <h3>レイヤ読込</h3>
      <div class="row">
        <input class="input" id="url" placeholder="例: data/onuma_ndvi_2024_summer.tif">
        <button class="btn" id="load">読込</button>
      </div>
      <div class="row">
        <button class="btn" id="quick">クイック読込（既定パス）</button>
        <span class="small">data/onuma_ndvi_2024_summer.tif</span>
      </div>
      <div class="row">
        <input type="file" id="file" accept=".tif,.tiff" style="display:none">
        <button class="btn" id="pick">ローカルTIFF</button>
      </div>
      <hr>
      <div class="row">
        <label class="small">透過度: <span id="opv">0.80</span></label>
      </div>
      <input type="range" id="opacity" class="slider" min="0" max="1" step="0.01" value="0.80">
      <div class="small">※ 背景地図との比較にご利用ください。</div>
    </div>

    <div class="card">
      <h3>ログ</h3>
      <div id="log" class="small"></div>
    </div>
  </aside>

  <main class="map">
    <div id="map"></div>
    <!-- 右下：凡例（単バンド時に表示） -->
    <div id="legend" class="legend" style="display:none">
      <h4 id="legendTitle">NDVI</h4>
      <div id="grad" class="gradient"></div>
      <div class="legend-scale">
        <span id="minLbl">-0.2</span>
        <span id="midLbl">0.35</span>
        <span id="maxLbl">0.9</span>
      </div>
    </div>
  </main>
</div>

<script>
/* ===== ログ ===== */
function logMsg(msg,isErr=false){
  const el=document.getElementById('log'); const p=document.createElement('div');
  p.className='logline'+(isErr?' err':''); p.textContent=(isErr?'ERROR: ':'')+msg;
  el.appendChild(p); console[isErr?'error':'log'](msg);
}

/* ===== GeoRaster系：動的ロード＋フェイルオーバー ===== */
function haveParseGeoraster(){
  return (window.parseGeoraster) ||
         (window.georaster && window.georaster.parseGeoraster) ||
         (window.GeoRaster && window.GeoRaster.parseGeoraster);
}
function getParseGeoraster(){ return haveParseGeoraster(); }

function loadScript(url){
  return new Promise((resolve,reject)=>{
    const s=document.createElement('script');
    s.src=url; s.async=false;
    // 過度な referrerPolicy/crossOrigin 指定はCDNと相性が悪いことがあるので外す
    s.onload=()=>resolve(url);
    s.onerror=()=>{ s.remove(); reject(new Error('failed '+url)); };
    document.head.appendChild(s);
  });
}
async function tryAny(urls){
  let lastErr;
  for(const u of urls){
    try{ return await loadScript(u); }catch(e){ lastErr=e; }
  }
  throw lastErr || new Error('all failed');
}
function cdnVariants(pkgAndPath){
  return [
    `https://unpkg.com/${pkgAndPath}`,
    `https://cdn.jsdelivr.net/npm/${pkgAndPath}`
  ];
}
async function ensureGeoRasterStack(){
  if (haveParseGeoraster() && window.GeoRasterLayer) return;

  // 1) geotiff
  await tryAny([
    ...cdnVariants('geotiff@2.1.3/dist-browser/geotiff.min.js'),
    ...cdnVariants('geotiff@2.1.2/dist-browser/geotiff.min.js'),
    ...cdnVariants('geotiff@2.0.7/dist-browser/geotiff.min.js'),
  ]);

  // 2) georaster（まず browser ビルド、次に min ビルドにフォールバック）
  const geoRasterCandidates = [];
  for (const ver of ['1.7.3','1.6.3','1.6.1']){
    for (const build of ['dist/georaster.browser.min.js','dist/georaster.min.js']){
      geoRasterCandidates.push(...cdnVariants(`georaster@${ver}/${build}`));
    }
  }
  await tryAny(geoRasterCandidates);

  // 3) proj4
  await tryAny([
    ...cdnVariants('proj4@2.9.2/dist/proj4.min.js'),
    ...cdnVariants('proj4@2.8.1/dist/proj4.min.js'),
  ]);

  // 4) georaster-proj4（georaster読込後にパッチ）
  await tryAny([
    ...cdnVariants('georaster-proj4@1.7.3/dist/georaster-proj4.browser.min.js'),
    ...cdnVariants('georaster-proj4@1.7.2/dist/georaster-proj4.browser.min.js'),
  ]);

  // 5) georaster-layer-for-leaflet
  await tryAny([
    ...cdnVariants('georaster-layer-for-leaflet@3.15.0/dist/georaster-layer-for-leaflet.min.js'),
    ...cdnVariants('georaster-layer-for-leaflet@3.14.0/dist/georaster-layer-for-leaflet.min.js'),
  ]);

  if (!haveParseGeoraster()) throw new Error('GeoRaster loaded but parseGeoraster not found');
  if (!window.GeoRasterLayer) throw new Error('GeoRasterLayer not found');
}

// スタック準備（失敗時はrethrowして以後を止める）
const READY = (async()=>{
  try{ await ensureGeoRasterStack(); }
  catch(e){ logMsg(e.message || String(e), true); throw e; }
})();

/* ===== 定数 ===== */
const DEFAULT_PATH = 'data/onuma_ndvi_2024_summer.tif';
const PALETTE_NDVI = ['#f7f7f7','#d9ef8b','#a6d96a','#66bd63','#1a9850','#006837'];
const NDVI_DOMAIN_DEFAULT = [-0.2, 0.9];

/* ===== 凡例ヘルパ ===== */
function makeGradientCSS(colors){ return `linear-gradient(to right, ${colors.join(',')})`; }
function updateLegend(vmin,vmax,palette,title='NDVI',lutColors=null){
  const box=document.getElementById('legend');
  const grad=document.getElementById('grad');
  document.getElementById('legendTitle').textContent=title;
  document.getElementById('minLbl').textContent=vmin.toFixed(2);
  document.getElementById('midLbl').textContent=((vmin+vmax)/2).toFixed(2);
  document.getElementById('maxLbl').textContent=vmax.toFixed(2);
  if(lutColors && lutColors.length>=256){
    const picks=[0,64,128,192,255].map(i=>lutColors[i]);
    grad.style.background=makeGradientCSS(picks);
  }else{
    grad.style.background=makeGradientCSS(palette);
  }
  box.style.display='block';
}
function hideLegend(){ document.getElementById('legend').style.display='none'; }

/* ===== Leaflet 初期化 ===== */
const map=L.map('map',{zoomControl:true,attributionControl:true}).setView([41.98,140.70],11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19,
  attribution:'© OpenStreetMap contributors'
}).addTo(map);
document.getElementById('fitOnuma').onclick=()=>map.setView([41.98,140.70],11);
let activeLayer=null;

/* ===== 取得ヘルパ ===== */
async function fetchArrayBufferSmart(urlOrFile){
  if (urlOrFile instanceof File) return await urlOrFile.arrayBuffer();
  const base = document.baseURI || window.location.href;
  const u = new URL(urlOrFile, base);
  const baseOrigin = new URL(base).origin;
  const same=(u.origin===baseOrigin);
  const res=await fetch(u.href,{mode: same?'same-origin':'cors', cache:'no-store'});
  if(!res.ok) throw new Error(`HTTP ${res.status} for ${u.href}`);
  return await res.arrayBuffer();
}

/* ===== TIFF 読込・描画 ===== */
async function loadGeoTiff(source){
  try{
    await READY; // スタック準備完了を保証
    const parse = getParseGeoraster();
    if (typeof parse!=='function') throw new Error('parseGeoraster not available（ライブラリ未ロード）');

    const buf = await fetchArrayBufferSmart(source);
    const georaster = await parse(buf);
    logMsg(`loaded: ${georaster.width}x${georaster.height}, bands=${georaster.numberOfRasters}, type=${georaster.dataType}, crs=${georaster.projection||'unknown'}`);

    // RGB 判定（bits/spp を優先）
    const bits = georaster.bitsPerSample;         // 例: [8,8,8]
    const spp  = georaster.samplesPerPixel;       // 例: 3
    const isRGB = (spp === 3 || georaster.numberOfRasters === 3) &&
                  (Array.isArray(bits) ? bits.every(b => b === 8)
                                       : /Uint8/i.test(String(georaster.dataType||'')));

    let options = { opacity: parseFloat(document.getElementById('opacity').value), resolution:256, resampleMethod:'bilinear' };

    if (isRGB){
      hideLegend();
    } else {
      const band=0, mins=georaster.mins||[], maxs=georaster.maxs||[];
      let vmin = Number.isFinite(mins[band]) ? mins[band] : NDVI_DOMAIN_DEFAULT[0];
      let vmax = Number.isFinite(maxs[band]) ? maxs[band] : NDVI_DOMAIN_DEFAULT[1];
      if (vmax - vmin <= 1e-6){ vmin=NDVI_DOMAIN_DEFAULT[0]; vmax=NDVI_DOMAIN_DEFAULT[1]; }

      const lut=(steps=256)=>{
        const cols=[]; const n=PALETTE_NDVI.length;
        const hex2rgb=h=>[parseInt(h.slice(1,3),16),parseInt(h.slice(3,5),16),parseInt(h.slice(5,7),16)];
        const rgb2hex=(r,g,b)=>'#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('');
        for(let i=0;i<steps;i++){
          const t=i/(steps-1), p=t*(n-1), i0=Math.floor(p), i1=Math.min(n-1,i0+1), lt=p-i0;
          const [r0,g0,b0]=hex2rgb(PALETTE_NDVI[i0]); const [r1,g1,b1]=hex2rgb(PALETTE_NDVI[i1]);
          const r=Math.round(r0+(r1-r0)*lt), g=Math.round(g0+(g1-g0)*lt), b=Math.round(b0+(b1-b0)*lt);
          cols.push(rgb2hex(r,g,b));
        }
        return cols;
      };
      const colors=lut();
      const toIdx=v=>{ const t=Math.max(0,Math.min(1,(v-vmin)/(vmax-vmin))); return Math.min(255,Math.max(0,Math.round(t*255))); };
      options.pixelValuesToColorFn=(vals)=>{ const v=vals[band]; if(v==null||Number.isNaN(v)) return null; return colors[toIdx(v)]; };
      updateLegend(vmin, vmax, PALETTE_NDVI, 'NDVI', colors);
    }

    const layer = new GeoRasterLayer({ georaster, ...options });
    if (activeLayer) map.removeLayer(activeLayer);
    activeLayer = layer.addTo(map);
    try{ map.fitBounds(layer.getBounds(),{padding:[10,10]}); }catch(e){}
  }catch(err){
    logMsg(err.message||String(err), true);
    alert('読み込みに失敗しました。パス/サイズ/CRS、またはネットワーク/拡張機能のブロックをご確認ください。');
  }
}

/* ===== READY 安全ラッパ ===== */
async function safeReady() {
  try { await READY; return true; }
  catch(e){ logMsg(e.message || String(e), true); return false; }
}

/* ===== UI 結線 ===== */
document.getElementById('load').onclick=async ()=>{
  if(!(await safeReady())) return;
  const path=document.getElementById('url').value.trim();
  if(path) loadGeoTiff(path);
};
document.getElementById('quick').onclick=async ()=>{
  if(!(await safeReady())) return;
  document.getElementById('url').value=DEFAULT_PATH;
  loadGeoTiff(DEFAULT_PATH);
};
document.getElementById('pick').onclick=()=>document.getElementById('file').click();
document.getElementById('file').onchange=async (e)=>{
  if(!(await safeReady())) return;
  const f=e.target.files?.[0]; if(f) loadGeoTiff(f);
};

/* ===== 透過度スライダー ===== */
document.getElementById('opacity').oninput=(e)=>{
  const v=parseFloat(e.target.value);
  document.getElementById('opv').textContent=v.toFixed(2);
  if(activeLayer) activeLayer.setOpacity(v);
};

/* ===== 起動時の自動読込（存在チェック付） ===== */
window.addEventListener('load', async ()=>{
  if(!(await safeReady())) return;
  try{
    const base = document.baseURI || window.location.href;
    const u=new URL(DEFAULT_PATH, base);
    if (u.origin === new URL(base).origin){
      const res=await fetch(u.href,{method:'HEAD',mode:'same-origin',cache:'no-store'});
      if(res.ok){ document.getElementById('url').value=DEFAULT_PATH; loadGeoTiff(DEFAULT_PATH); }
    }else{
      document.getElementById('url').value=DEFAULT_PATH;
      loadGeoTiff(DEFAULT_PATH);
    }
  }catch(e){ /* no-op */ }
});
</script>
</body>
</html>
