<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>KAKEHASHI | 森林樹高ダッシュボード</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- GeoTIFF / GeoRaster stack（順番が重要） -->
<script src="https://unpkg.com/proj4@2.9.2/dist/proj4.js"></script>
<script src="https://unpkg.com/geotiff@2.0.7/dist-browser/geotiff.min.js"></script>
<script src="https://unpkg.com/georaster@1.6.1/dist/georaster.min.js"></script>
<script src="https://unpkg.com/georaster-layer-for-leaflet@3.21.0/dist/georaster-layer-for-leaflet.min.js"></script>

<style>
html, body { height:100%; margin:0; font-family: sans-serif; }
#map { height:100%; width:100%; }
#panel {
  position:absolute; top:10px; left:10px; z-index:1000;
  background:rgba(17,24,39,0.9); color:#eee; padding:10px 14px;
  border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.4);
  font-size:14px;
}
label { display:block; margin:6px 0; }
</style>
</head>
<body>
<div id="map"></div>
<div id="panel">
  <b>森林樹高ダッシュボード</b><br>
  <button id="btnLoad">樹高レイヤ読込</button><br>
  <label>透過度: <input type="range" id="opacity" min="0" max="1" step="0.05" value="0.7"></label>
  <div id="resInfo">解像度: —</div>
</div>

<script>
// ========= 設定 =========
const DEFAULT_PATH = "data/onuma_canopy_height_8bit.tif";
const HEIGHT_MIN = 0, HEIGHT_MAX = 40; // 樹高範囲[m]
let rasterLayer = null;

// ========= カラーマップ =========
const LUT = Array.from({length:256}, (_,i)=>{
  const t = i/255;
  const r = Math.round(255 * t);
  const g = Math.round(255 * (1-t));
  return `rgb(${r},${g},0)`;
});

// ========= Leaflet マップ =========
const map = L.map('map').setView([41.9, 140.7], 12); // 大沼公園付近
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'&copy; OpenStreetMap'
}).addTo(map);

// ========= TIFF読込関数 =========
async function loadTiff(url){
  try{
    document.getElementById('btnLoad').disabled = true;
    const bust = (url.includes('?')?'&':'?') + 'v='+Date.now();
    const abs = new URL(url + bust, location.href).href;
    console.log('[load]', abs);

    const res = await fetch(abs,{cache:'no-store'});
    if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
    const buf = await res.arrayBuffer();

    // georaster.js で定義済みの関数
    const georaster = await parseGeoraster(buf);
    console.log('[georaster]', georaster);

    if(rasterLayer){ map.removeLayer(rasterLayer); rasterLayer=null; }

    const isUint8 = (georaster.dataType||'').toLowerCase().includes('8');
    const toIdx = v=>{
      if(v==null || Number.isNaN(v)) return null;
      let m=v;
      if(isUint8) m = (v/255)*(HEIGHT_MAX-HEIGHT_MIN)+HEIGHT_MIN;
      if(m===0) return null; // 背景透過
      const t=Math.max(0,Math.min(1,(m-HEIGHT_MIN)/(HEIGHT_MAX-HEIGHT_MIN)));
      return Math.round(t*255);
    };

    rasterLayer = new GeoRasterLayer({
      georaster, resolution:256,
      opacity: parseFloat(document.getElementById('opacity').value),
      pixelValuesToColorFn: values=>{
        const idx=toIdx(values[0]);
        return idx==null?null:LUT[idx];
      }
    }).addTo(map);

    try{
      const bb=rasterLayer.getBounds();
      if(bb && bb.isValid()) map.fitBounds(bb);
    }catch(e){ console.warn('fitBounds skipped',e); }

    const scale = georaster.pixelWidth || georaster.pixelHeight || null;
    document.getElementById('resInfo').textContent = scale?`${scale.toFixed(1)} m/pix`:'—';
  }catch(err){
    console.error(err);
    alert("読み込み失敗: "+err.message);
  }finally{
    document.getElementById('btnLoad').disabled = false;
  }
}

// ========= イベント =========
document.getElementById('btnLoad').addEventListener('click',()=>loadTiff(DEFAULT_PATH));
document.getElementById('opacity').addEventListener('input',e=>{
  if(rasterLayer) rasterLayer.setOpacity(parseFloat(e.target.value));
});

// ========= 自動読み込み =========
loadTiff(DEFAULT_PATH);
</script>
</body>
</html>
