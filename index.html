<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KAKEHASHI | Forestry MVP (Leaflet + GeoTIFF)</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<!-- GeoTIFF stack -->
<script src="https://unpkg.com/geotiff@2.1.3/dist-browser/geotiff.min.js"></script>
<script src="https://unpkg.com/georaster@1.6.1/dist/georaster.browser.min.js"></script>
<script src="https://unpkg.com/georaster-layer-for-leaflet@3.15.0/dist/georaster-layer-for-leaflet.min.js"></script>

<!-- 色設定用（1バンドstretchのために最小限のカラーマップ） -->
<script>
/* 簡易パレット: NDVI系 (薄灰→黄緑→濃緑) と NBR系 (赤→肌→白) */
const PALETTES = {
  ndvi: ['#f7f7f7','#d9ef8b','#a6d96a','#66bd63','#1a9850','#006837'],
  nbr:  ['#7f0000','#d7301f','#ef6548','#fdbb84','#fee8c8','#f7f7f7']
};
function makeColorScale(palette, steps=256){
  const n = palette.length;
  // 線形補間でsteps色を生成
  const hex2rgb = h=>[parseInt(h.slice(1,3),16),parseInt(h.slice(3,5),16),parseInt(h.slice(5,7),16)];
  const rgb2hex = (r,g,b)=>'#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('');
  const cols = [];
  for(let i=0;i<steps;i++){
    const t = i/(steps-1);
    const p = t*(n-1);
    const i0 = Math.floor(p), i1 = Math.min(n-1, i0+1);
    const lt = p - i0;
    const [r0,g0,b0] = hex2rgb(palette[i0]);
    const [r1,g1,b1] = hex2rgb(palette[i1]);
    const r = Math.round(r0+(r1-r0)*lt);
    const g = Math.round(g0+(g1-g0)*lt);
    const b = Math.round(b0+(b1-b0)*lt);
    cols.push(rgb2hex(r,g,b));
  }
  return cols;
}
</script>

<style>
:root{
  --bg:#0b1020; --panel:#111827; --text:#e5e7eb; --muted:#9ca3af;
  --accent:#22d3ee; --accent2:#a78bfa; --chip:#0b1326; --chipb:#2a3953;
  --ok:#16a34a; --warn:#f59e0b; --line:#243045;
}
*{box-sizing:border-box}
html,body{height:100%; margin:0; background:var(--bg); color:var(--text); font-family:Inter,system-ui,ui-sans-serif,Segoe UI,Roboto}
.app{display:grid; grid-template-columns: 340px 1fr; grid-template-rows: auto 1fr; grid-template-areas:
  "header header" "sidebar map"; height:100%}
.header{grid-area:header; padding:10px 14px; border-bottom:1px solid var(--line); display:flex; gap:12px; align-items:center}
.header h1{font-size:16px; margin:0; font-weight:700}
.header .sub{color:var(--muted); font-size:12px}
.sidebar{grid-area:sidebar; border-right:1px solid var(--line); padding:12px; overflow:auto; background:#0f162c}
.map{grid-area:map}
#map{height:100%; width:100%}

/* cards */
.card{background:linear-gradient(180deg,#0f1934,#0c1530); border:1px solid #1f2a44; border-radius:14px; padding:12px; box-shadow:0 10px 30px rgba(0,0,0,.25); margin-bottom:12px}
.card h3{margin:0 0 8px; font-size:13px}
.row{display:flex; gap:8px; align-items:center; margin-top:8px}
.input{flex:1; background:#0b1326; border:1px solid #223153; color:var(--text); padding:8px 10px; border-radius:10px}
.btn{background:linear-gradient(180deg,#1c2750,#141d3a); border:1px solid #293a64; color:#e6f6ff; padding:8px 10px; border-radius:10px; cursor:pointer}
.btn:hover{filter:brightness(1.1)}
.small{font-size:12px; color:var(--muted)}
.badge{font-size:11px; background:#132042; color:#c8eefd; border:1px solid #274071; padding:2px 6px; border-radius:999px}
.drop{border:1px dashed #2a3d6d; border-radius:12px; padding:10px; text-align:center; color:var(--muted); background:#0b1326}
.slider{width:100%}
.legend{display:flex; gap:6px; align-items:center; margin-top:8px; flex-wrap:wrap}
.legend .sw{width:16px; height:12px; border-radius:3px; border:1px solid rgba(255,255,255,.2)}
hr{border:none; border-top:1px solid var(--line); margin:10px 0}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <h1>KAKEHASHI Forestry MVP</h1>
    <div class="sub">Leaflet + GeoTIFF（NDVI/NBR / RGB or 1-band）</div>
    <span class="badge">Stage 0</span>
  </div>

  <aside class="sidebar">
    <div class="card">
      <h3>1) ベースマップ</h3>
      <div class="row">
        <button class="btn" id="fitOnuma">大沼にフォーカス</button>
      </div>
      <div class="row small">OSM/国土地理院タイル等は後段で切替追加可能</div>
    </div>

    <div class="card" id="ndviCard">
      <h3>2) NDVI レイヤ</h3>
      <div class="row">
        <input class="input" id="ndviUrl" placeholder="NDVI GeoTIFF の URL（同一オリジン推奨）" />
        <button class="btn" id="ndviLoadUrl">読込</button>
      </div>
      <div class="row">
        <input type="file" id="ndviFile" accept=".tif,.tiff" style="display:none" />
        <button class="btn" id="ndviPick">ローカルTIFF</button>
      </div>
      <div class="drop small" id="ndviDrop">ここにNDVIのTIFFをドラッグ＆ドロップ</div>
      <hr>
      <div class="small">可視域: <span id="ndviRangeLbl">auto</span></div>
      <input type="range" class="slider" id="ndviOpacity" min="0" max="1" step="0.01" value="0.85">
      <div class="legend" id="ndviLegend"></div>
    </div>

    <div class="card" id="nbrCard">
      <h3>3) NBR レイヤ</h3>
      <div class="row">
        <input class="input" id="nbrUrl" placeholder="NBR GeoTIFF の URL（同一オリジン推奨）" />
        <button class="btn" id="nbrLoadUrl">読込</button>
      </div>
      <div class="row">
        <input type="file" id="nbrFile" accept=".tif,.tiff" style="display:none" />
        <button class="btn" id="nbrPick">ローカルTIFF</button>
      </div>
      <div class="drop small" id="nbrDrop">ここにNBRのTIFFをドラッグ＆ドロップ</div>
      <hr>
      <div class="small">可視域: <span id="nbrRangeLbl">auto</span></div>
      <input type="range" class="slider" id="nbrOpacity" min="0" max="1" step="0.01" value="0.85">
      <div class="legend" id="nbrLegend"></div>
    </div>

    <div class="card">
      <h3>Tips</h3>
      <div class="small">
        ・GEEの <b>visualize()</b> 出力（8bit RGB）→ 何も設定不要でそのまま表示可。<br>
        ・GEEの <b>生値1バンドTIFF</b> → 自動でmin/maxを推定して擬似カラー化（NDVI/NBR向け）。<br>
        ・URL読込はCORS制限に注意。<b>GitHub Pages上にTIFFを置く</b>と確実です。
      </div>
    </div>
  </aside>

  <main class="map"><div id="map"></div></main>
</div>

<script>
// ====== Leaflet 基本 ======
const map = L.map('map', { zoomControl:true, attributionControl:true }).setView([41.98, 140.70], 11);
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19, attribution:'© OpenStreetMap'
}).addTo(map);
document.getElementById('fitOnuma').onclick = () => map.setView([41.98, 140.70], 11);

// レイヤ参照
let ndviLayer = null, nbrLayer = null;

// ====== 汎用: GeoTIFF -> georaster-layer-for-leaflet ======
async function addGeoTiffLayer({source, target='ndvi', paletteKey='ndvi'}){
  // source: URL or File
  const arrayBuffer = source instanceof File ? await source.arrayBuffer() : await (await fetch(source)).arrayBuffer();
  const georaster = await parseGeoraster(arrayBuffer);

  // 8bit RGB?（3バンド & 0-255） → そのまま描画
  const isRGB = georaster.numberOfRasters >= 3 && georaster.dataType.includes('8');
  let options = { opacity: 0.85, pixelValuesToColorFn: null, resolution: 256 };

  if(isRGB){
    // georaster-layer-for-leaflet が自動でRGB合成
    options = { ...options };
  } else {
    // 1バンド（生値） → min/maxからストレッチ & パレット塗り
    const band = 0;
    // min/max 推定（NoDataを除外できる範囲で簡易スキャン）
    const { mins, maxs } = georaster;
    let vmin = mins[band], vmax = maxs[band];
    // NDVI/NBR の妥当域でクリップ（過外れ値対策）
    const defaultDomain = (paletteKey==='ndvi') ? [-0.2, 0.9] : [-0.5, 1.0];
    if(!isFinite(vmin) || !isFinite(vmax) || vmin===vmax){
      vmin = defaultDomain[0]; vmax = defaultDomain[1];
    } else {
      // ドメインが極端なら既定域に寄せる
      const span = vmax - vmin;
      if(span<=1e-6){ vmin = defaultDomain[0]; vmax = defaultDomain[1]; }
    }
    const lut = makeColorScale(PALETTES[paletteKey], 256);
    const toIdx = (v)=> {
      const t = Math.max(0, Math.min(1, (v - vmin)/(vmax - vmin)));
      return Math.min(255, Math.max(0, Math.round(t*255)));
    };
    options.pixelValuesToColorFn = (vals)=>{
      const v = vals[band];
      if(v==null || Number.isNaN(v)) return null;
      return lut[toIdx(v)];
    };
    // UIラベル更新
    document.getElementById(target==='ndvi' ? 'ndviRangeLbl' : 'nbrRangeLbl').textContent = `${vmin.toFixed(2)} … ${vmax.toFixed(2)}`;
    // 簡易凡例更新
    renderLegend(target==='ndvi' ? 'ndviLegend' : 'nbrLegend', PALETTES[paletteKey]);
  }

  const layer = new GeoRasterLayer({ georaster, ...options });
  layer.addTo(map);

  if(target==='ndvi'){
    if(ndviLayer) map.removeLayer(ndviLayer);
    ndviLayer = layer;
    layer.setOpacity(parseFloat(document.getElementById('ndviOpacity').value));
  }else{
    if(nbrLayer) map.removeLayer(nbrLayer);
    nbrLayer = layer;
    layer.setOpacity(parseFloat(document.getElementById('nbrOpacity').value));
  }

  // TIFFのバウンディングでフィット（初回のみズームを合わせたい場合は条件分岐）
  try { map.fitBounds(layer.getBounds(), { padding:[10,10] }); } catch(e){}
}

// ====== UI結線（NDVI/NBR） ======
function bindInputs(prefix, paletteKey){
  const pickBtn = document.getElementById(prefix+'Pick');
  const fileInp = document.getElementById(prefix+'File');
  const urlInp  = document.getElementById(prefix+'Url');
  const loadBtn = document.getElementById(prefix+'LoadUrl');
  const drop    = document.getElementById(prefix+'Drop');
  const opac    = document.getElementById(prefix+'Opacity');

  pickBtn.onclick = ()=> fileInp.click();
  fileInp.onchange = (e)=>{
    const f = e.target.files?.[0];
    if(f) addGeoTiffLayer({source:f, target: prefix==='ndvi'?'ndvi':'nbr', paletteKey});
  };
  loadBtn.onclick = ()=>{
    const url = urlInp.value.trim();
    if(url) addGeoTiffLayer({source:url, target: prefix==='ndvi'?'ndvi':'nbr', paletteKey});
  };
  drop.ondragover = (e)=>{ e.preventDefault(); drop.style.background='#0e1a36'; };
  drop.ondragleave= ()=> drop.style.background='';
  drop.ondrop = (e)=>{
    e.preventDefault(); drop.style.background='';
    const f = e.dataTransfer.files?.[0];
    if(f) addGeoTiffLayer({source:f, target: prefix==='ndvi'?'ndvi':'nbr', paletteKey});
  };
  opac.oninput = ()=>{
    const v = parseFloat(opac.value);
    const layer = prefix==='ndvi'? ndviLayer : nbrLayer;
    if(layer) layer.setOpacity(v);
  };
}
bindInputs('ndvi','ndvi');
bindInputs('nbr','nbr');

// ====== 凡例描画 ======
function renderLegend(elemId, colors){
  const el = document.getElementById(elemId);
  el.innerHTML = '';
  colors.forEach(c=>{
    const sw = document.createElement('div');
    sw.className = 'sw';
    sw.style.background = c;
    el.appendChild(sw);
  });
}
</script>
</body>
</html>
