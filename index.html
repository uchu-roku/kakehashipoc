<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GeoTIFF Quick Viewer</title>

<!-- ↓ご自身の GitHub Pages ルートに合わせて必要なら変更してください -->
<base href="https://uchu-roku.github.io/kakehashipoc/">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- GeoTIFF / GeoRaster stack -->
<script src="https://unpkg.com/geotiff@2.1.3/dist-browser/geotiff.min.js"></script>
<script src="https://unpkg.com/georaster@1.6.1/dist/georaster.browser.min.js"></script>
<script src="https://unpkg.com/georaster-layer-for-leaflet@3.15.0/dist/georaster-layer-for-leaflet.min.js"></script>

<!-- 再投影が必要なTIFFに備えて（不要なら削除OK） -->
<script src="https://unpkg.com/proj4@2.9.2/dist/proj4.js"></script>
<script src="https://unpkg.com/georaster-proj4@1.7.2/dist/georaster-proj4.browser.min.js"></script>

<style>
  html,body,#map{height:100%;margin:0}
  .legend{position:absolute;right:10px;bottom:10px;background:#fff;padding:8px 10px;border-radius:8px;font:12px/1.4 system-ui;border:1px solid #ddd}
  .grad{height:10px;width:220px;background:linear-gradient(to right,#f7f7f7,#d9ef8b,#a6d96a,#66bd63,#1a9850,#006837);margin-top:6px;border:1px solid #ccc}
</style>
</head>
<body>
<div id="map"></div>
<div id="legend" class="legend" style="display:none">
  <div><strong>NDVI</strong> <span id="rng"></span></div>
  <div class="grad"></div>
  <div style="display:flex;justify-content:space-between"><span id="vmin">-</span><span id="vmid">-</span><span id="vmax">-</span></div>
</div>

<script>
(async () => {
  // ===== 設定 =====
  const TIF_PATH = 'data/onuma_ndvi_2024_summer.tif'; // 読み込みたい GeoTIFF パス
  const OPACITY  = 0.80;

  // ===== 地図初期化 =====
  const map = L.map('map').setView([42.0, 140.7], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, attribution: '© OpenStreetMap'
  }).addTo(map);

  // ===== TIFF 読み込み =====
  try {
    const res = await fetch(new URL(TIF_PATH, window.location.href), {cache:'no-store'});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const arrayBuffer = await res.arrayBuffer();
    const georaster = await parseGeoraster(arrayBuffer);

    // RGB or 単バンドの単純判定
    const isRGB = georaster.numberOfRasters >= 3;

    // 単バンド時は NDVI を想定してストレッチ＋色付け
    const opts = { georaster, opacity: OPACITY, resolution: 256, resampleMethod: 'bilinear' };
    if(!isRGB){
      const band = 0;
      // georaster.mins/maxs があれば利用、なければ NDVI 想定の既定値
      let vmin = Number.isFinite(georaster.mins?.[band]) ? georaster.mins[band] : -0.2;
      let vmax = Number.isFinite(georaster.maxs?.[band]) ? georaster.maxs[band] : 0.9;
      if(vmax - vmin < 1e-6){ vmin = -0.2; vmax = 0.9; }

      const palette = ['#f7f7f7','#d9ef8b','#a6d96a','#66bd63','#1a9850','#006837'];
      // 256色のルックアップ作成
      const hex2rgb=h=>[parseInt(h.slice(1,3),16),parseInt(h.slice(3,5),16),parseInt(h.slice(5,7),16)];
      const rgb2hex=(r,g,b)=>'#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('');
      const lut = (() => {
        const cols=[], n=palette.length;
        for(let i=0;i<256;i++){
          const t=i/255, p=t*(n-1), i0=Math.floor(p), i1=Math.min(n-1,i0+1), lt=p-i0;
          const [r0,g0,b0]=hex2rgb(palette[i0]); const [r1,g1,b1]=hex2rgb(palette[i1]);
          const r=Math.round(r0+(r1-r0)*lt), g=Math.round(g0+(g1-g0)*lt), b=Math.round(b0+(b1-b0)*lt);
          cols.push(rgb2hex(r,g,b));
        }
        return cols;
      })();
      const toIdx = v => {
        const t = Math.max(0, Math.min(1, (v - vmin) / (vmax - vmin)));
        return Math.min(255, Math.max(0, Math.round(t * 255)));
      };
      opts.pixelValuesToColorFn = (vals) => {
        const v = vals[band];
        if (v == null || Number.isNaN(v)) return null; // NoData
        return lut[toIdx(v)];
      };

      // 凡例表示
      const leg = document.getElementById('legend');
      document.getElementById('rng').textContent  = `(${vmin.toFixed(2)}〜${vmax.toFixed(2)})`;
      document.getElementById('vmin').textContent = vmin.toFixed(2);
      document.getElementById('vmid').textContent = ((vmin+vmax)/2).toFixed(2);
      document.getElementById('vmax').textContent = vmax.toFixed(2);
      leg.style.display = 'block';
    }

    const layer = new GeoRasterLayer(opts).addTo(map);
    try { map.fitBounds(layer.getBounds(), {padding:[10,10]}); } catch(e){ /* 失敗時は既定中心のまま */ }

  } catch (err) {
    console.error('TIFF 読み込み失敗:', err);
    alert('TIFF の読み込みに失敗しました。パス、ファイル配置、GitHub Pages 設定を確認してください。');
  }
})();
</script>
</body>
</html>
